version: "2.2"
services:
  prh:
    image: nexus3.onap.org:10001/onap/org.onap.dcaegen2.services.prh.prh-app-server:latest
    ports:
      - "8100:8100"
      - "8433:8433"
    volumes:
      - ./simulator/certs:/tmp/certs
    environment:
      - HOSTNAME=dcae-prh
      - CONSUL_HOST                # not in use, but still required by SDK - should be removed later on
      - CONFIG_BINDING_SERVICE
      - CONFIG_BINDING_SERVICE_SERVICE_PORT
    container_name: prh
    depends_on:
      cbs:
        condition: service_healthy
      dmaap-mr:
        condition: service_started
      aai:
        condition: service_started

  dmaap-mr:
    build:
      context: simulator
      dockerfile: DMaaP_simulator
    ports:
      - "2222:2222"
      - "2223:2223"
      - "2224:2224"
    container_name: dmaap_simulator

  aai:
    build:
      context: simulator
      dockerfile: AAI_simulator
    ports:
      - "3333:3333"
      - "3334:3334"
      - "3335:3335"
    container_name: aai_simulator

  consul:
    image: consul:1.0.6
    ports:
      - "8500:8500"
    command: ["agent", "-bootstrap", "-client=0.0.0.0", "-server", "-ui", "-config-dir=/consul/consul.d"]
    volumes:
      - ./consul.d/:/consul/consul.d
    container_name: consul

  consul-cfg:
    image: consul:1.0.6
    restart: on-failure
    command: ["kv", "put", "-http-addr=http://consul:8500", "dcae-prh", '{
                                              "logging.level.org.onap.dcaegen2.services.prh": "debug",
                                              "logging.level.org.onap.dcaegen2.services.sdk": "debug",
                                              "dmaap.dmaapConsumerConfiguration.dmaapUserName":"admin",
                                              "dmaap.dmaapConsumerConfiguration.dmaapUserPassword":"admin",
                                              "dmaap.dmaapConsumerConfiguration.dmaapContentType": "application/json",
                                              "dmaap.dmaapConsumerConfiguration.consumerId": "c12",
                                              "dmaap.dmaapConsumerConfiguration.consumerGroup": "OpenDCAE-c12",
                                              "dmaap.dmaapConsumerConfiguration.timeoutMs": -1,
                                              "dmaap.dmaapProducerConfiguration.dmaapUserName":"admin",
                                              "dmaap.dmaapProducerConfiguration.dmaapUserPassword":"admin",
                                              "dmaap.dmaapProducerConfiguration.dmaapContentType": "application/json",
                                              "dmaap.dmaapUpdateProducerConfiguration.dmaapUserName": "admin",
                                              "dmaap.dmaapUpdateProducerConfiguration.dmaapUserPassword": "admin",
                                              "dmaap.dmaapUpdateProducerConfiguration.dmaapContentType": "application/json",
                                              "aai.aaiClientConfiguration.pnfUrl":"https://aai:3334/aai/v12/network/pnfs/pnf",
                                              "aai.aaiClientConfiguration.aaiUserName": "DCAE",
                                              "aai.aaiClientConfiguration.aaiUserPassword": "DCAE",
                                              "aai.aaiClientConfiguration.aaiIgnoreSslCertificateErrors": true,
                                              "aai.aaiClientConfiguration.aaiServiceInstancePath":"/business/customers/customer/${customer}/service-subscriptions/service-subscription/${serviceType}/service-instances/service-instance/${serviceInstanceId}",
                                              "aai.aaiClientConfiguration.aaiHeaders":{
                                                "X-FromAppId": "prh",
                                                "X-TransactionId": "9999",
                                                "Accept": "application/json",
                                                "Real-Time": "true",
                                                "Authorization": "Basic QUFJOkFBSQ=="
                                              },
                                              "security.trustStorePath":"/tmp/certs/truststore.jks",
                                              "security.trustStorePasswordPath":"/tmp/certs/truststore.password",
                                              "security.keyStorePath":"/tmp/certs/keystore.p12",
                                              "security.keyStorePasswordPath":"/tmp/certs/keystore.password",
                                              "security.enableAaiCertAuth":true,
                                              "security.enableDmaapCertAuth":true,

                                              "streams_publishes":{
                                                "pnf-update":{
                                                  "type": "message_router",
                                                  "dmaap_info":{
                                                    "topic_url":"https://dmaap-mr:2223/events/unauthenticated.PNF_UPDATE"
                                                  }
                                                },
                                                "pnf-ready":{
                                                  "type": "message_router",
                                                  "dmaap_info":{
                                                    "topic_url":"https://dmaap-mr:2223/events/unauthenticated.PNF_READY"
                                                  }
                                                }
                                              },
                                              "streams_subscribes":{
                                                "ves-reg-output":{
                                                  "type": "message_router",
                                                  "dmaap_info":{
                                                    "topic_url":"https://dmaap-mr:2223/events/unauthenticated.VES_PNFREG_OUTPUT"
                                                  }
                                                }
                                              }
                                            }'
    ]
    container_name: consul-cfg
    depends_on:
      - consul

  consul-cfg-dcae-ves-collector:
    image: consul:1.0.6
    restart: on-failure
    command: ["kv", "put", "-http-addr=http://consul:8500", "dcae-ves-collector",'{
                                            "collector.dynamic.config.update.frequency": "5",
                                            "event.transform.flag": "0",
                                            "collector.schema.checkflag": "1",
                                            "collector.dmaap.streamid": "fault=ves-fault|syslog=ves-syslog|heartbeat=ves-heartbeat|measurementsForVfScaling=ves-measurement|mobileFlow=ves-mobileflow|other=ves-other|stateChange=ves-statechange|thresholdCrossingAlert=ves-thresholdCrossingAlert|voiceQuality=ves-voicequality|sipSignaling=ves-sipsignaling|notification=ves-notification|pnfRegistration=ves-pnfRegistration",
                                            "collector.service.port": "8080",
                                            "collector.schema.file":"{
                                              \"v1\":\"./etc/CommonEventFormat_27.2.json\",
                                              \"v2\":\"./etc/CommonEventFormat_27.2.json\",
                                              \"v3\":\"./etc/CommonEventFormat_27.2.json\",
                                              \"v4\":\"./etc/CommonEventFormat_27.2.json\",
                                              \"v5\":\"./etc/CommonEventFormat_28.4.1.json\",
                                              \"v7\":\"./etc/CommonEventFormat_30.0.1.json\"
                                            }",
                                            "collector.keystore.passwordfile": "/opt/app/VESCollector/etc/passwordfile",
                                            "collector.inputQueue.maxPending": "8096",
                                            "streams_publishes":{
                                              "ves-measurement": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.VES_MEASUREMENT_OUTPUT/"
                                                }
                                              },
                                              "ves-fault": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.SEC_FAULT_OUTPUT/"
                                                }
                                              },
                                              "ves-pnfRegistration": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.VES_PNFREG_OUTPUT/"
                                                }
                                              },
                                              "ves-other": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.SEC_OTHER_OUTPUT/"
                                                }
                                              },
                                              "ves-heartbeat": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.SEC_HEARTBEAT_OUTPUT/"
                                                }
                                              },
                                              "ves-notification": {
                                                "type": "message_router",
                                                "dmaap_info": {
                                                  "topic_url": "http://dmaap-mr:2222/events/unauthenticated.VES_NOTIFICATION_OUTPUT/"
                                                  }
                                              }
                                            },
                                            "collector.service.secure.port": "8443",
                                            "header.authflag": "0",
                                            "collector.keystore.file.location": "/opt/app/VESCollector/etc/keystore",
                                            "collector.keystore.alias":
                                            "dynamically generated",
                                            "services_calls": [],
                                            "header.authlist": "sample1,c2FtcGxlMQ=="
                                            }']
    container_name: consul-cfg-dcae-ves-collector
    depends_on:
      - consul


  cbs:
    image: nexus3.onap.org:10001/onap/org.onap.dcaegen2.platform.configbinding.app-app:2.2.4
    ports:
      - "10000:10000"
    environment:
      - CONSUL_HOST
    depends_on:
      - consul-cfg
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10000/service_component_all/dcae-prh"]
      interval: 3s
      timeout: 2s
      retries: 20
    container_name: cbs
